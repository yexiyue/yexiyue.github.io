<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rust-cli-serve | 红尘散仙</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script>
          var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?b0aae218897fa9d8a9f76e9a77e0b3c6";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
          })();
        </script>
    <meta name="description" content="男儿不展凌云志，空负天生八尺躯">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.ddb4ef27.css" as="style"><link rel="preload" href="/assets/js/app.0cb9f04a.js" as="script"><link rel="preload" href="/assets/js/3.bef602aa.js" as="script"><link rel="preload" href="/assets/js/1.0846dacc.js" as="script"><link rel="preload" href="/assets/js/81.9c0e369b.js" as="script"><link rel="prefetch" href="/assets/js/10.9894a91a.js"><link rel="prefetch" href="/assets/js/11.b2374a7c.js"><link rel="prefetch" href="/assets/js/12.ea8b5875.js"><link rel="prefetch" href="/assets/js/13.e1e021bd.js"><link rel="prefetch" href="/assets/js/14.cae939a8.js"><link rel="prefetch" href="/assets/js/15.8cc0d2d2.js"><link rel="prefetch" href="/assets/js/16.26c91372.js"><link rel="prefetch" href="/assets/js/17.fc715829.js"><link rel="prefetch" href="/assets/js/18.c6c92042.js"><link rel="prefetch" href="/assets/js/19.fc08edee.js"><link rel="prefetch" href="/assets/js/20.12ee7d74.js"><link rel="prefetch" href="/assets/js/21.32c79218.js"><link rel="prefetch" href="/assets/js/22.a16691d3.js"><link rel="prefetch" href="/assets/js/23.77d431c0.js"><link rel="prefetch" href="/assets/js/24.16a94ed8.js"><link rel="prefetch" href="/assets/js/25.3dde9f3a.js"><link rel="prefetch" href="/assets/js/26.3268d1c9.js"><link rel="prefetch" href="/assets/js/27.c64d35d2.js"><link rel="prefetch" href="/assets/js/28.afcd3359.js"><link rel="prefetch" href="/assets/js/29.e4d3114d.js"><link rel="prefetch" href="/assets/js/30.517d121b.js"><link rel="prefetch" href="/assets/js/31.f6bf346c.js"><link rel="prefetch" href="/assets/js/32.d56b14ac.js"><link rel="prefetch" href="/assets/js/33.3700438f.js"><link rel="prefetch" href="/assets/js/34.eb30aa53.js"><link rel="prefetch" href="/assets/js/35.db8d0765.js"><link rel="prefetch" href="/assets/js/36.1f8c2dfb.js"><link rel="prefetch" href="/assets/js/37.297e541b.js"><link rel="prefetch" href="/assets/js/38.ec0803a2.js"><link rel="prefetch" href="/assets/js/39.bb7ac598.js"><link rel="prefetch" href="/assets/js/4.9247e068.js"><link rel="prefetch" href="/assets/js/40.cbe01d8d.js"><link rel="prefetch" href="/assets/js/41.f6456105.js"><link rel="prefetch" href="/assets/js/42.05f60ec1.js"><link rel="prefetch" href="/assets/js/43.0674b9d8.js"><link rel="prefetch" href="/assets/js/44.5765be6a.js"><link rel="prefetch" href="/assets/js/45.5d9f35a3.js"><link rel="prefetch" href="/assets/js/46.030f7aeb.js"><link rel="prefetch" href="/assets/js/47.07dd52c9.js"><link rel="prefetch" href="/assets/js/48.e78b8049.js"><link rel="prefetch" href="/assets/js/49.d32e302b.js"><link rel="prefetch" href="/assets/js/5.d095e1ee.js"><link rel="prefetch" href="/assets/js/50.1eecfa45.js"><link rel="prefetch" href="/assets/js/51.f7a399b9.js"><link rel="prefetch" href="/assets/js/52.3890b0b8.js"><link rel="prefetch" href="/assets/js/53.b645276a.js"><link rel="prefetch" href="/assets/js/54.f72ce5ac.js"><link rel="prefetch" href="/assets/js/55.89b59738.js"><link rel="prefetch" href="/assets/js/56.185c06d5.js"><link rel="prefetch" href="/assets/js/57.ab74cb27.js"><link rel="prefetch" href="/assets/js/58.e8089504.js"><link rel="prefetch" href="/assets/js/59.54daecc8.js"><link rel="prefetch" href="/assets/js/6.4b098c25.js"><link rel="prefetch" href="/assets/js/60.f3a9fa22.js"><link rel="prefetch" href="/assets/js/61.0b12189a.js"><link rel="prefetch" href="/assets/js/62.01b636f4.js"><link rel="prefetch" href="/assets/js/63.a73d6815.js"><link rel="prefetch" href="/assets/js/64.5d30270a.js"><link rel="prefetch" href="/assets/js/65.7232f7e3.js"><link rel="prefetch" href="/assets/js/66.5b6c625e.js"><link rel="prefetch" href="/assets/js/67.af0b29c0.js"><link rel="prefetch" href="/assets/js/68.37d41e0d.js"><link rel="prefetch" href="/assets/js/69.745e3d74.js"><link rel="prefetch" href="/assets/js/7.60a31fcf.js"><link rel="prefetch" href="/assets/js/70.d560c665.js"><link rel="prefetch" href="/assets/js/71.e2419e4a.js"><link rel="prefetch" href="/assets/js/72.705b9a59.js"><link rel="prefetch" href="/assets/js/73.b7916eef.js"><link rel="prefetch" href="/assets/js/74.3000263e.js"><link rel="prefetch" href="/assets/js/75.cbf92486.js"><link rel="prefetch" href="/assets/js/76.63720d51.js"><link rel="prefetch" href="/assets/js/77.f2b3381b.js"><link rel="prefetch" href="/assets/js/78.4e1ed04f.js"><link rel="prefetch" href="/assets/js/79.c78d8b08.js"><link rel="prefetch" href="/assets/js/8.98ca8354.js"><link rel="prefetch" href="/assets/js/80.02b9c759.js"><link rel="prefetch" href="/assets/js/82.a43c39a9.js"><link rel="prefetch" href="/assets/js/83.d9b70adf.js"><link rel="prefetch" href="/assets/js/84.e57009f5.js"><link rel="prefetch" href="/assets/js/85.c8ee73ec.js"><link rel="prefetch" href="/assets/js/86.47070d3a.js"><link rel="prefetch" href="/assets/js/87.474d9a96.js"><link rel="prefetch" href="/assets/js/88.30c995c8.js"><link rel="prefetch" href="/assets/js/89.37e1b7df.js"><link rel="prefetch" href="/assets/js/9.bffde177.js"><link rel="prefetch" href="/assets/js/90.0d83bb28.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ddb4ef27.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-1db74182><div data-v-1db74182><div id="loader-wrapper" class="loading-wrapper" data-v-0101338e data-v-1db74182 data-v-1db74182><div class="loader-main" data-v-0101338e><div data-v-0101338e></div><div data-v-0101338e></div><div data-v-0101338e></div><div data-v-0101338e></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-5cb9a64e data-v-1db74182 data-v-1db74182><h3 class="title" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e>红尘散仙</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><input type="password" value="" data-v-5cb9a64e> <span data-v-5cb9a64e>Konck! Knock!</span> <button data-v-5cb9a64e>OK</button></label> <div class="footer" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><span data-v-5cb9a64e><i class="iconfont reco-theme" data-v-5cb9a64e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5cb9a64e>vuePress-theme-reco</a></span> <span data-v-5cb9a64e><i class="iconfont reco-copyright" data-v-5cb9a64e></i> <a data-v-5cb9a64e><span data-v-5cb9a64e>红尘散仙</span>
            
          <span data-v-5cb9a64e>2022 - </span>
          2024
        </a></span></div></div> <div class="hide" data-v-1db74182><div data-v-1db74182><div id="smart" class="wrapper-page" style="background-image:url(/homeImage/8.jpg);background-position-x:center;background-position-y:center;background-size:cover;background-repeat-x:no-repeat;background-repeat-y:no-repeat;" data-v-1db74182><header class="navbar" data-v-1db74182><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="红尘散仙" class="logo"> <span class="site-name">红尘散仙</span></a> <div class="links"><div id="dayNightSwitch" class="generalWrapper" data-v-32f44868><a class="click" data-v-32f44868><div class="onOff daySwitch" data-v-32f44868><div class="star star1" data-v-32f44868></div> <div class="star star2" data-v-32f44868></div> <div class="star star3" data-v-32f44868></div> <div class="star star4" data-v-32f44868></div> <div class="star star5" data-v-32f44868></div> <div class="star sky" data-v-32f44868></div> <div class="sunMoon" data-v-32f44868><div class="crater crater1" data-v-32f44868></div> <div class="crater crater2" data-v-32f44868></div> <div class="crater crater3" data-v-32f44868></div> <div class="cloud part1" data-v-32f44868></div> <div class="cloud part2" data-v-32f44868></div></div></div></a></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/练习项目/" class="nav-link"><i class="iconfont undefined"></i>
  练习项目
</a></li><li class="dropdown-item"><!----> <a href="/categories/浅浅探索/" class="nav-link"><i class="iconfont undefined"></i>
  浅浅探索
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="iconfont undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/源码学习/" class="nav-link"><i class="iconfont undefined"></i>
  源码学习
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试系列/" class="nav-link"><i class="iconfont undefined"></i>
  面试系列
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1db74182></div> <aside class="sidebar" data-v-1db74182><div class="personal-info-wrapper" data-v-03833281 data-v-1db74182><img src="/avatar-top.png" alt="author-avatar" class="personal-img" data-v-03833281> <h3 class="name" data-v-03833281>
    红尘散仙
  </h3> <div class="num" data-v-03833281><div data-v-03833281><h3 data-v-03833281>74</h3> <h6 data-v-03833281>文章</h6></div> <div data-v-03833281><h3 data-v-03833281>51</h3> <h6 data-v-03833281>标签</h6></div></div> <hr data-v-03833281></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/练习项目/" class="nav-link"><i class="iconfont undefined"></i>
  练习项目
</a></li><li class="dropdown-item"><!----> <a href="/categories/浅浅探索/" class="nav-link"><i class="iconfont undefined"></i>
  浅浅探索
</a></li><li class="dropdown-item"><!----> <a href="/categories/学习笔记/" class="nav-link"><i class="iconfont undefined"></i>
  学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/源码学习/" class="nav-link"><i class="iconfont undefined"></i>
  源码学习
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试系列/" class="nav-link"><i class="iconfont undefined"></i>
  面试系列
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-5cb9a64e data-v-1db74182><h3 class="title" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e>Rust-cli-serve</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><input type="password" value="" data-v-5cb9a64e> <span data-v-5cb9a64e>Konck! Knock!</span> <button data-v-5cb9a64e>OK</button></label> <div class="footer" style="display:none;" data-v-5cb9a64e data-v-5cb9a64e><span data-v-5cb9a64e><i class="iconfont reco-theme" data-v-5cb9a64e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-5cb9a64e>vuePress-theme-reco</a></span> <span data-v-5cb9a64e><i class="iconfont reco-copyright" data-v-5cb9a64e></i> <a data-v-5cb9a64e><span data-v-5cb9a64e>红尘散仙</span>
            
          <span data-v-5cb9a64e>2022 - </span>
          2024
        </a></span></div></div></div> <div data-v-1db74182><main class="page"><div class="page-title" style="display:none;"><h1 class="title">Rust-cli-serve</h1> <div class="page-info" data-v-0efa1f05><i class="iconfont reco-account" data-v-0efa1f05><span data-v-0efa1f05>红尘散仙</span></i> <i class="iconfont reco-date" data-v-0efa1f05><span data-v-0efa1f05>2023-08-20</span></i> <i class="iconfont reco-eye" data-v-0efa1f05><span id="/blogs/2023/2023-08-20.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-0efa1f05><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-0efa1f05><span class="tag-item" data-v-0efa1f05>rust</span><span class="tag-item" data-v-0efa1f05>后端</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p class="custom-block-title">介绍</p> <p>为rust-cli 提供后端服务，用于模版的管理</p></div> <h2 id="rust-cli-serve"><a href="#rust-cli-serve" class="header-anchor">#</a> Rust-cli-serve</h2> <p><strong>为rust-cli 提供后端服务，用于模版的管理</strong></p> <h2 id="_1-创建mongo-docker镜像"><a href="#_1-创建mongo-docker镜像" class="header-anchor">#</a> 1.创建mongo docker镜像</h2> <p>直接参考菜鸟教程<a href="https://www.runoob.com/docker/docker-install-mongodb.html" target="_blank" rel="noopener noreferrer">Docker 安装 MongoDB | 菜鸟教程 (runoob.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>按照教程创建好数据库后如何切换到其他数据库，创建该数据库账户</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">'yexiyue'</span>,pwd:<span class="token string">'123456'</span>,roles:<span class="token punctuation">[</span><span class="token punctuation">{</span>role:<span class="token string">'readWrite'</span>,db:<span class="token string">'cli_db'</span><span class="token punctuation">}</span>,<span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_2-学习使用mongo连接数据库"><a href="#_2-学习使用mongo连接数据库" class="header-anchor">#</a> 2.学习使用mongo连接数据库</h2> <h3 id="_1-连接数据库"><a href="#_1-连接数据库" class="header-anchor">#</a> 1.连接数据库</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">mongodb<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">options<span class="token punctuation">::</span></span><span class="token class-name">ClientOptions</span><span class="token punctuation">,</span> <span class="token class-name">Client</span><span class="token punctuation">,</span> <span class="token class-name">Database</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tracing<span class="token punctuation">::</span></span>info<span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Database</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> client_option <span class="token operator">=</span> <span class="token class-name">ClientOptions</span><span class="token punctuation">::</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://yexiyue:123456@127.0.0.1:27017/cli_db&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;failed to parse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> client <span class="token operator">=</span> <span class="token class-name">Client</span><span class="token punctuation">::</span><span class="token function">with_options</span><span class="token punctuation">(</span>client_option<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> client<span class="token operator">=</span>client<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">&quot;cli_db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> db_name<span class="token operator">=</span>client<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;connect to mongodb {db_name} success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-server层封装"><a href="#_2-server层封装" class="header-anchor">#</a> 2.server层封装</h3> <p><strong>通过请求扩展获取数据库句柄，然后根据传入的范型使用集合，然后封装成extract</strong></p> <p><strong>server.rs</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>db<span class="token punctuation">::</span></span><span class="token class-name">MongoDB</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">async_trait<span class="token punctuation">::</span></span>async_trait<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">axum<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">extract<span class="token punctuation">::</span></span><span class="token class-name">FromRequestParts</span><span class="token punctuation">,</span>
    <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">request<span class="token punctuation">::</span></span><span class="token class-name">Parts</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">mongodb<span class="token punctuation">::</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> collection<span class="token punctuation">:</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">FromRequestParts</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Rejection</span> <span class="token operator">=</span> <span class="token class-name">StatusCode</span><span class="token punctuation">;</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_request_parts</span><span class="token punctuation">(</span>parts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Parts</span><span class="token punctuation">,</span> _state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Rejection</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取请求扩展中的数据库句柄</span>
        <span class="token keyword">let</span> mongod <span class="token operator">=</span> parts<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">MongoDB</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过类型名称设置集合</span>
        <span class="token keyword">let</span> type_name <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>any<span class="token punctuation">::</span></span><span class="token function">type_name</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> type_name<span class="token operator">=</span>type_name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> collection <span class="token operator">=</span> mongod<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>type_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span> collection <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>使用</strong></p> <p>先为特点范型实现方法，然后通过extract可以直接使用</p> <p><strong>User/server.rs</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">futures<span class="token punctuation">::</span>stream<span class="token punctuation">::</span></span><span class="token class-name">TryStreamExt</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">mongodb<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">bson<span class="token punctuation">::</span></span><span class="token punctuation">{</span>doc<span class="token punctuation">,</span> <span class="token class-name">DateTime</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">results<span class="token punctuation">::</span></span><span class="token class-name">InsertOneResult</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Deserialize</span><span class="token punctuation">,</span> <span class="token class-name">Serialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>server<span class="token punctuation">::</span></span><span class="token class-name">Server</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Role</span> <span class="token punctuation">{</span>
    <span class="token class-name">Admin</span><span class="token punctuation">,</span>
    <span class="token class-name">Normal</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">User</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    create_time<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">,</span>
    role<span class="token punctuation">:</span> <span class="token class-name">Role</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_user</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
        role<span class="token punctuation">:</span> <span class="token class-name">Role</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">InsertOneResult</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">self</span>
            <span class="token punctuation">.</span>collection
            <span class="token punctuation">.</span><span class="token function">insert_one</span><span class="token punctuation">(</span>
                <span class="token class-name">User</span> <span class="token punctuation">{</span>
                    username<span class="token punctuation">,</span>
                    password<span class="token punctuation">,</span>
                    role<span class="token punctuation">,</span>
                    create_time<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">find_users</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> cursor <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> result<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">try_next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>控制层</strong></p> <p><strong>user/controler.rs</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">axum<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">response<span class="token punctuation">::</span></span><span class="token class-name">IntoResponse</span><span class="token punctuation">,</span> <span class="token class-name">Json</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token namespace">server<span class="token punctuation">::</span></span><span class="token class-name">Server</span><span class="token punctuation">,</span> <span class="token namespace">user<span class="token punctuation">::</span>server<span class="token punctuation">::</span></span><span class="token class-name">Role</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>server<span class="token punctuation">::</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug, serde::Deserialize, serde::Serialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">UserParams</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    role<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_user</span><span class="token punctuation">(</span>server<span class="token punctuation">:</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Json</span><span class="token operator">&lt;</span><span class="token class-name">UserParams</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">IntoResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> server
        <span class="token punctuation">.</span><span class="token function">create_user</span><span class="token punctuation">(</span>
            user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            user<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
            <span class="token keyword">match</span> user<span class="token punctuation">.</span>role <span class="token punctuation">{</span>
                <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token class-name">Role</span><span class="token punctuation">::</span><span class="token class-name">Normal</span><span class="token punctuation">,</span>
                <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token class-name">Role</span><span class="token punctuation">::</span><span class="token class-name">Admin</span><span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Json</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_user</span><span class="token punctuation">(</span>server<span class="token punctuation">:</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">IntoResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">find_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Json</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>最后导出路由</strong></p> <p><strong>user/mod.rs</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">axum<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">routing<span class="token punctuation">::</span></span>post<span class="token punctuation">,</span> <span class="token class-name">Router</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token keyword">self</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>controller<span class="token punctuation">::</span></span><span class="token punctuation">{</span>create_user<span class="token punctuation">,</span> get_user<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">controller</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">server</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">user_routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Router</span> <span class="token punctuation">{</span>
    <span class="token class-name">Router</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">,</span> <span class="token function">post</span><span class="token punctuation">(</span>create_user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>get_user<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>结果</strong></p> <p><img src="2023-08-20.assets/image-20230822130302946.png" alt="image-20230822130302946"></p> <h2 id="_3-jwt"><a href="#_3-jwt" class="header-anchor">#</a> 3.jwt</h2> <p><strong>Jwt.rs</strong></p> <p>封装jwt方法</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">jsonwebtoken<span class="token punctuation">::</span></span><span class="token punctuation">{</span>decode<span class="token punctuation">,</span> encode<span class="token punctuation">,</span> <span class="token class-name">DecodingKey</span><span class="token punctuation">,</span> <span class="token class-name">EncodingKey</span><span class="token punctuation">,</span> <span class="token class-name">Header</span><span class="token punctuation">,</span> <span class="token class-name">Validation</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Deserialize</span><span class="token punctuation">,</span> <span class="token class-name">Serialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Claims</span> <span class="token punctuation">{</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    role<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    exp<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token constant">TOKEN_KEY</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token string">&quot;yexiyue666&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">Claims</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> role<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            username<span class="token punctuation">,</span>
            role<span class="token punctuation">,</span>
            <span class="token comment">// 默认验证过期时间</span>
            exp<span class="token punctuation">:</span> <span class="token number">2000000000</span><span class="token punctuation">,</span><span class="token comment">//required</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">encode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token namespace">jsonwebtoken<span class="token punctuation">::</span>errors<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">encode</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token class-name">Header</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token class-name">EncodingKey</span><span class="token punctuation">::</span><span class="token function">from_secret</span><span class="token punctuation">(</span><span class="token constant">TOKEN_KEY</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">decode</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token namespace">jsonwebtoken<span class="token punctuation">::</span>errors<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> claims <span class="token operator">=</span> <span class="token function">decode</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
            token<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token class-name">DecodingKey</span><span class="token punctuation">::</span><span class="token function">from_secret</span><span class="token punctuation">(</span><span class="token constant">TOKEN_KEY</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token class-name">Validation</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span>claims<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><h2 id="_4-错误处理"><a href="#_4-错误处理" class="header-anchor">#</a> 4.错误处理</h2> <p>src/error.rs</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">axum<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">,</span>
    <span class="token namespace">response<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">IntoResponse</span><span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">Json</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token punctuation">{</span>json<span class="token punctuation">,</span> <span class="token class-name">Value</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ServerError</span><span class="token punctuation">(</span><span class="token keyword">pub</span> <span class="token class-name">StatusCode</span><span class="token punctuation">,</span> <span class="token keyword">pub</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">IntoResponse</span> <span class="token keyword">for</span> <span class="token class-name">ServerError</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">into_response</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Response</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token class-name">Json</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token macro property">json!</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">:</span>status<span class="token punctuation">.</span><span class="token function">as_u16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">:</span><span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>status<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>实现一个自定义的错误处理结构 ServerError,用于将服务器错误信息格式化成 JSON 响应返回给客户端。</strong></p> <p><strong>它定义了一个结构体 ServerError,包含了一个状态码和一个错误信息字符串。这个结构体实现了 IntoResponse trait。</strong></p> <p><strong>在 IntoResponse 的 into_response 方法中,它会构造一个 JSON 对象,包含状态码、错误信息和一个 error 标志。然后它会把这个 JSON 对象和状态码组装成一个 Response 返回。</strong></p> <p><strong>这样在路由处理函数中,当出现错误时,可以创建一个 ServerError 的实例,并返回它,该实例会被自动转换成正确格式的 JSON 错误响应。</strong></p> <p><strong>这种方式避免了在每个路由函数中都需要重复构造错误 JSON 的麻烦,提供了一个可复用的错误处理方案。</strong></p> <p><strong>它接受状态码和错误信息字符串作为输入,输出是一个可直接返回的错误响应。通过自定义的错误结构体和 IntoResponse 实现,简化了错误处理流程。</strong></p> <h2 id="_5-使用bcrypt加密密码"><a href="#_5-使用bcrypt加密密码" class="header-anchor">#</a> 5.使用bcrypt加密密码</h2> <p><a href="https://crates.io/crates/bcrypt" target="_blank" rel="noopener noreferrer">bcrypt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>src/user/controller.rs</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_user</span><span class="token punctuation">(</span>server<span class="token punctuation">:</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Json</span><span class="token operator">&lt;</span><span class="token class-name">UserParams</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">IntoResponse</span> <span class="token punctuation">{</span>
    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> password<span class="token operator">=</span>user<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
    <span class="token comment">// Hash password</span>
    <span class="token keyword">let</span> password<span class="token operator">=</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token namespace">bcrypt<span class="token punctuation">::</span></span><span class="token constant">DEFAULT_COST</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> server
        <span class="token punctuation">.</span><span class="token function">create_user</span><span class="token punctuation">(</span>
            user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            password<span class="token punctuation">,</span>
            <span class="token keyword">match</span> user<span class="token punctuation">.</span>role <span class="token punctuation">{</span>
                <span class="token number">0</span> <span class="token operator">=&gt;</span> <span class="token class-name">Role</span><span class="token punctuation">::</span><span class="token class-name">Normal</span><span class="token punctuation">,</span>
                <span class="token number">1</span> <span class="token operator">=&gt;</span> <span class="token class-name">Role</span><span class="token punctuation">::</span><span class="token class-name">Admin</span><span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Json</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个函数的目的是创建一个新的用户。</p> <p>它接受两个输入:</p> <ol><li>server - 一个 Server 实例,包含了创建用户的方法。</li> <li>user - 一个封装了用户名、密码和角色的 UserParams 结构体。</li></ol> <p>在函数内部,首先打印出用户信息。然后获取密码,用 bcrypt 算法进行哈希处理。</p> <p>接下来调用 server 的 create_user 方法,根据用户信息创建新用户,并保存到数据库中。</p> <p>最后用创建的用户信息封装成一个 JSON 响应返回。</p> <p>所以这个函数的主要逻辑是:</p> <ol><li>获取用户注册信息</li> <li>对密码hash加密</li> <li>调用服务端方法保存新用户</li> <li>返回结果</li></ol> <p>通过这些步骤,它实现了一个注册新用户的功能。</p> <h2 id="_6-mongodb-createindex"><a href="#_6-mongodb-createindex" class="header-anchor">#</a> 6.mongodb createIndex</h2> <p><strong>在 MongoDB Rust 驱动中,indexModel 用于定义要创建的索引的字段和配置。主要的使用方式如下:</strong></p> <ol><li>单字段索引</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token class-name">IndexModel</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token macro property">doc!</span><span class="token punctuation">{</span> <span class="token string">&quot;fieldname&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里对fieldname建立正序索引。</p> <ol start="2"><li>复合索引</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token class-name">IndexModel</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token macro property">doc!</span><span class="token punctuation">{</span> 
        <span class="token string">&quot;fieldname1&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;fieldname2&quot;</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span>  
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里对fieldname1正序,fieldname2倒序建立复合索引。</p> <ol start="3"><li>多键索引</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token class-name">IndexModel</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token macro property">doc!</span><span class="token punctuation">{</span> <span class="token string">&quot;arrayfield&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token class-name">IndexOptions</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multikey</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对数组字段建立多键索引,需要设置multikey选项。</p> <ol start="4"><li>地理空间索引</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token class-name">IndexModel</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token macro property">doc!</span><span class="token punctuation">{</span> <span class="token string">&quot;location&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2dsphere&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对location字段建立地理位置索引。</p> <ol start="5"><li>自定义配置</li></ol> <p>可以设置唯一性,部分过滤等选项。</p> <p><strong>在 MongoDB 中,可以通过以下两种方式设置索引的唯一性:</strong></p> <ol><li>在创建索引时,通过IndexOptions设置unique为true:</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token class-name">IndexOptions</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token class-name">IndexModel</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token macro property">doc!</span><span class="token punctuation">{</span> <span class="token string">&quot;fieldname&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

collection<span class="token punctuation">.</span><span class="token function">create_index</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span> 
</code></pre></div><ol start="2"><li>在创建集合时,通过CollectionOptions设置validator为一个验证函数:</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token class-name">CollectionOptions</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>doc<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// 自定义验证逻辑 </span>
        <span class="token comment">// 返回错误即验证失败</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> collection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">create_collection</span><span class="token punctuation">(</span><span class="token string">&quot;collection_name&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们可以实现自定义的文档验证逻辑,在插入/更新时验证,确保字段值唯一。</p> <p>另外,也可以在应用层对写入数据库的文档提前做唯一性校验。</p> <h2 id="_7-serverinit"><a href="#_7-serverinit" class="header-anchor">#</a> 7.ServerInit</h2> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">ServerInit</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ServeResult</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ServerInit</code> 是一个 trait,它定义了一个服务器初始化时需要实现的方法 <code>init()</code>。</p> <p>这个 trait 的主要作用是:</p> <ol><li>将服务器初始化的逻辑抽象成一个 trait,提高代码的模块化和可重用性。</li> <li>通过为不同的 <code>Server&lt;T&gt;</code> 实现 <code>ServerInit</code>,可以自定义每个服务器的初始化逻辑,如创建索引,初始化连接等。</li> <li>保证所有的初始化逻辑会在服务器启动时执行,不需要手动调用。</li> <li>可以在 <code>init()</code> 中做一些只需要执行一次的操作,如创建索引,不会重复执行。</li> <li>让服务器启动前的初始化工作更加规范化。</li> <li>可以通过返回 <code>Result</code> 来处理初始化中的错误。</li></ol> <p>所以综上,<code>ServerInit</code> trait 主要是通过定义一个标准的初始化接口,来帮助实现模块化的服务器初始化逻辑,让不同的服务器可以自定义初始化过程,同时也使得初始化过程更加规范化。</p> <p>它提高了服务器初始化相关代码的可重用性、模块化、健壮性和可维护性。</p> <p><strong>完整Server代码</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> collection<span class="token punctuation">:</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">ServerInit</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ServeResult</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">FromRequestParts</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token class-name">ServerInit</span><span class="token punctuation">,</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Send</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Rejection</span> <span class="token operator">=</span> <span class="token class-name">ServerError</span><span class="token punctuation">;</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_request_parts</span><span class="token punctuation">(</span>parts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Parts</span><span class="token punctuation">,</span> _state<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">S</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Rejection</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取请求扩展中的数据库句柄</span>
        <span class="token keyword">let</span> mongod <span class="token operator">=</span> parts<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">MongoDB</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过类型名称设置集合</span>
        <span class="token keyword">let</span> type_name <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>any<span class="token punctuation">::</span></span><span class="token function">type_name</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> type_name <span class="token operator">=</span> type_name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> collection <span class="token operator">=</span> mongod<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>type_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span> collection <span class="token punctuation">}</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>例子</strong></p> <p><strong>user/server.rs</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">impl</span> <span class="token class-name">ServerInit</span> <span class="token keyword">for</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ServeResult</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>collection
            <span class="token punctuation">.</span><span class="token function">create_index</span><span class="token punctuation">(</span>
                <span class="token class-name">IndexModel</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token macro property">doc!</span> <span class="token punctuation">{</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token class-name">IndexOptions</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token keyword">await</span>
            <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>err<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;{err:?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ServerError</span><span class="token punctuation">(</span>
                    <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Failed to create index&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;ServerInit {res:#?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_8-序列化"><a href="#_8-序列化" class="header-anchor">#</a> 8.序列化</h2> <p><strong>需要用到bson crate</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, Serialize, Deserialize)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">User</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[serde(
        serialize_with = <span class="token string">&quot;bson::serde_helpers::serialize_object_id_as_hex_string&quot;</span>,
        rename = <span class="token string">&quot;_id&quot;</span>
    )]</span>
    id<span class="token punctuation">:</span> <span class="token class-name">ObjectId</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[serde(serialize_with = <span class="token string">&quot;bson::serde_helpers::serialize_bson_datetime_as_rfc3339_string&quot;</span>)]</span>
    create_time<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">,</span>
    role<span class="token punctuation">:</span> <span class="token class-name">Role</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个代码片段中,<code>User</code> 结构体实现了对 MongoDB 文档 ID 的序列化和反序列化。</p> <p>具体来看,<code>id</code> 字段的类型是 <code>ObjectId</code>,这是 MongoDB 文档 ID 的类型。</p> <p>通过 <code>#[serde(serialize_with = &quot;...&quot;)]</code> 标注,在序列化时会调用 <code>bson::serde_helpers::serialize_object_id_as_hex_string</code> 函数来把 <code>ObjectId</code> 序列化成一个字符串形式的 ID。</p> <p>同时 <code>#[serde(rename=&quot;_id&quot;)]</code> 标注将 <code>id</code> 字段序列化时映射成 <code>_id</code>,因为 MongoDB 文档的 ID 字段名是 <code>_id</code>。</p> <p>在反序列化时,会根据这些标注自动将字符串形式的 <code>_id</code> 反序列化成一个 <code>ObjectId</code> 类型赋值给 <code>id</code> 字段。</p> <p>这样,就可以使 <code>User</code> 结构体适配 MongoDB 文档的 ID 字段,使得可以直接存取文档 ID 了。</p> <p>另外 <code>create_time</code> 字段也做了类似处理,将 <code>DateTime</code> 类型序列化成 BSON 日期时间格式。</p> <p>所以通过 Serde 的标注,可以方便地实现对 MongoDB 文档的序列化和反序列化。</p> <p><img src="2023-08-20.assets/image-20230829210552082.png" alt="image-20230829210552082"></p> <h2 id="_9-文件上传"><a href="#_9-文件上传" class="header-anchor">#</a> 9.文件上传</h2> <p>Axum 的 Multipart extractor 目前只支持提取上传的文件,不支持直接提取字符串形式的表单字段。</p> <p>Multipart 主要是用来处理文件上传的。如果要提交普通的表单字段,需要使用 Form extractor:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">axum<span class="token punctuation">::</span>extract<span class="token punctuation">::</span></span><span class="token class-name">Form</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">handler</span><span class="token punctuation">(</span><span class="token class-name">Form</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Form</span><span class="token operator">&lt;</span><span class="token class-name">MyForm</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// form 可以是结构体也可以是 Value</span>
  <span class="token keyword">let</span> username <span class="token operator">=</span> form<span class="token punctuation">.</span>username<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Deserialize)]</span>  
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyForm</span> <span class="token punctuation">{</span>
  username<span class="token punctuation">:</span> <span class="token class-name">String</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Form 可以提取请求体中的 x-www-form-urlencoded 格式或 JSON 格式的数据,所以可以用来获取表单中的字符串字段。</p> <p>如果既需要上传文件,又需要普通表单字段,可以同时使用 Multipart 和 Form extractor,在不同的 handler 中提取不同类型的数据。</p> <p>所以综上,Axum 的 Multipart 是专门用来提取上传文件而非字符串字段的。这点需要和 Form 区分开来。</p> <h3 id="通用文件上传-md5计算文件摘要作为文件名保存"><a href="#通用文件上传-md5计算文件摘要作为文件名保存" class="header-anchor">#</a> 通用文件上传，md5计算文件摘要作为文件名保存</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Path</span><span class="token punctuation">,</span> <span class="token class-name">PathBuf</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">ServerError</span><span class="token punctuation">,</span> <span class="token class-name">ServeResult</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">axum<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">extract<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">DefaultBodyLimit</span><span class="token punctuation">,</span> <span class="token class-name">Multipart</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">StatusCode</span><span class="token punctuation">,</span>
    <span class="token namespace">response<span class="token punctuation">::</span></span><span class="token class-name">IntoResponse</span><span class="token punctuation">,</span>
    <span class="token namespace">routing<span class="token punctuation">::</span></span>post<span class="token punctuation">,</span>
    <span class="token class-name">Json</span><span class="token punctuation">,</span> <span class="token class-name">Router</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span>json<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">tracing<span class="token punctuation">::</span></span>info<span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">hash</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> digest <span class="token operator">=</span> <span class="token namespace">md5<span class="token punctuation">::</span></span><span class="token function">compute</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{digest:?}&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_extension</span><span class="token punctuation">(</span>filename<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">upload</span><span class="token punctuation">(</span><span class="token keyword">mut</span> multipart<span class="token punctuation">:</span> <span class="token class-name">Multipart</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ServeResult</span><span class="token operator">&lt;</span><span class="token keyword">impl</span> <span class="token class-name">IntoResponse</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> urls <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span> multipart
        <span class="token punctuation">.</span><span class="token function">next_field</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">ServerError</span><span class="token punctuation">(</span><span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">BAD_REQUEST</span><span class="token punctuation">,</span> <span class="token string">&quot;bad request&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> path <span class="token operator">=</span> <span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> filename <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">file_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> ext <span class="token operator">=</span> <span class="token function">get_extension</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> bytes <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{filename}.{ext}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        path<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;write file:{path:?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">tokio<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerError</span><span class="token punctuation">(</span>
                <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span>
                <span class="token string">&quot;write file error&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:3000/{}&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        urls<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Json</span><span class="token punctuation">(</span><span class="token macro property">json!</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span>urls<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">upload_router</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Router</span> <span class="token punctuation">{</span>
    <span class="token class-name">Router</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">,</span> <span class="token function">post</span><span class="token punctuation">(</span>upload<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">layer</span><span class="token punctuation">(</span><span class="token class-name">DefaultBodyLimit</span><span class="token punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="静态文件服务"><a href="#静态文件服务" class="header-anchor">#</a> 静态文件服务</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token namespace">std<span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">Error</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token class-name">Router</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token function">user_routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token function">template_router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token namespace">upload<span class="token punctuation">::</span></span><span class="token function">upload_router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">layer</span><span class="token punctuation">(</span><span class="token class-name">CorsLayer</span><span class="token punctuation">::</span><span class="token function">permissive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">layer</span><span class="token punctuation">(</span><span class="token namespace">middleware<span class="token punctuation">::</span></span><span class="token function">from_fn</span><span class="token punctuation">(</span>authorization_middleware<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">layer</span><span class="token punctuation">(</span><span class="token class-name">CatchPanicLayer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">layer</span><span class="token punctuation">(</span><span class="token class-name">Extension</span><span class="token punctuation">(</span><span class="token namespace">db<span class="token punctuation">::</span></span><span class="token class-name">MongoDB</span><span class="token punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  			<span class="token comment">// 回退服务</span>
        <span class="token punctuation">.</span><span class="token function">fallback_service</span><span class="token punctuation">(</span><span class="token class-name">Router</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nest_service</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
            <span class="token function">get_service</span><span class="token punctuation">(</span><span class="token namespace">tower_http<span class="token punctuation">::</span>services<span class="token punctuation">::</span></span><span class="token class-name">ServeDir</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">SocketAddr</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Server</span><span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">into_make_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;Server started at {}&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这段代码的作用是创建一个HTTP服务，并将其设置为当请求的路径无法匹配任何其他服务时的回退服务。</p> <p>代码步骤如下：</p> <ol><li>创建一个新的路由器（Router）对象。</li> <li>使用nest_service方法将一个路径为&quot;/&quot;的服务嵌套到路由器中。</li> <li>使用get_service方法创建一个静态文件服务（ServeDir），并将其设置为嵌套服务的处理程序。</li> <li>使用fallback_service方法将嵌套服务设置为回退服务。</li></ol> <h2 id="_10-登录验证中间件"><a href="#_10-登录验证中间件" class="header-anchor">#</a> 10.登录验证中间件</h2> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> <span class="token constant">WHITE_LIST</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;/user/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/template/list&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">authorization_middleware</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    user<span class="token punctuation">:</span><span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    req<span class="token punctuation">:</span> <span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    next<span class="token punctuation">:</span> <span class="token class-name">Next</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ServeResult</span><span class="token operator">&lt;</span><span class="token class-name">Response</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token operator">&amp;</span>i <span class="token keyword">in</span> <span class="token constant">WHITE_LIST</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> req<span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">starts_with</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">typed_get</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Authorization</span><span class="token operator">&lt;</span><span class="token class-name">Bearer</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Authorization</span><span class="token punctuation">(</span>bearer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> token <span class="token punctuation">{</span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> bearer<span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> claims<span class="token operator">=</span><span class="token class-name">Claims</span><span class="token punctuation">::</span><span class="token function">decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> res<span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">find_user_by_username</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> res<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ServerError</span><span class="token punctuation">(</span><span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">,</span><span class="token string">&quot;用户不存在&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ServerError</span><span class="token punctuation">(</span><span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">,</span><span class="token string">&quot;未经许可&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>它的作用是在处理HTTP请求之前对请求进行授权验证。首先，它定义了一个名为WHITE_LIST的常量数组，其中包含了两个字符串&quot;/user/login&quot;和&quot;/template/list&quot;。然后，它定义了一个名为authorization_middleware的异步函数，接受三个参数：user、req和next。   函数中的for循环遍历WHITE_LIST数组中的每个元素。如果请求的URI路径以WHITE_LIST中的任何一个元素开头，那么就返回next.run(req).await的结果，即继续处理请求。   如果请求的URI路径不在WHITE_LIST中，那么就从请求的头部中获取Authorization头，并解析出其中的Bearer令牌。如果解析成功，就使用令牌解码出其中的Claims信息，并通过user服务查找与Claims中的用户名匹配的用户。如果找不到匹配的用户，就返回一个包含UNAUTHORIZED状态码和&quot;用户不存在&quot;错误消息的ServerError。如果请求中没有Authorization头，就返回一个包含UNAUTHORIZED状态码和&quot;未经许可&quot;错误消息的ServerError。   最后，如果授权验证通过，就返回next.run(req).await的结果，即继续处理请求。</strong></p> <h2 id="_11-once-cell"><a href="#_11-once-cell" class="header-anchor">#</a> 11.once_cell</h2> <p><strong>只创建一次索引</strong></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">static</span> <span class="token constant">FIRST</span><span class="token punctuation">:</span> <span class="token class-name">Lazy</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Lazy</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[async_trait]</span>
<span class="token keyword">impl</span> <span class="token class-name">ServerInit</span> <span class="token keyword">for</span> <span class="token class-name">Server</span><span class="token operator">&lt;</span><span class="token class-name">User</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ServeResult</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> first <span class="token operator">=</span> <span class="token constant">FIRST</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> first <span class="token operator">=</span> first<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token operator">*</span><span class="token operator">*</span>first <span class="token punctuation">{</span>
            <span class="token operator">*</span><span class="token operator">*</span>first <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">self</span>
                <span class="token punctuation">.</span>collection
                <span class="token punctuation">.</span><span class="token function">create_index</span><span class="token punctuation">(</span>
                    <span class="token class-name">IndexModel</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token macro property">doc!</span> <span class="token punctuation">{</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token class-name">IndexOptions</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">await</span>
                <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>err<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;{err:?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ServerError</span><span class="token punctuation">(</span>
                        <span class="token class-name">StatusCode</span><span class="token punctuation">::</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;Failed to create index&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>src/user/server.rs</code> 中的一部分。</p> <p>这段代码的目的是在 MongoDB 数据库的 users 集合中创建一个唯一索引。</p> <p>具体来说,它定义了一个叫 <code>FIRST</code> 的静态变量,这个变量包含一个布尔值,默认是 <code>true</code>。</p> <p>然后它实现了 <code>ServerInit</code> trait 的 <code>init</code> 方法。这个方法会在服务器启动时被调用。</p> <p>在 <code>init</code> 方法中,它先获取 <code>FIRST</code> 变量的锁,然后借用这个锁来修改 <code>FIRST</code> 的值。</p> <p>如果 <code>FIRST</code> 的值是 <code>true</code>,就表示这是服务器第一次启动,需要创建索引。它会把 <code>FIRST</code> 设置为 <code>false</code>,然后调用 MongoDB 的 <code>create_index</code> 方法在 users 集合的 username 字段上创建一个唯一索引。</p> <p>创建索引可能会失败,所以它用 <code>?</code> 运算符来处理错误。如果成功,就返回 <code>Ok(())</code>。</p> <p>如果 <code>FIRST</code> 已经是 <code>false</code> 了,就直接返回 <code>Ok(())</code>,因为索引已经创建过了。</p> <p>这样,它可以保证在服务器第一次启动时创建唯一索引,并且之后不再重复创建。</p> <p>总结一下,这段代码的作用是在服务器初始化时在 MongoDB 集合中创建唯一索引,输入是数据库集合,输出是创建索引的结果,通过检查一个标志变量来决定是否需要创建索引。它可以确保索引只被创建一次。</p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023/11/29 20:49:19</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-e58f9186 data-v-e58f9186><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-e58f9186><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-e58f9186></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-e58f9186></path></svg></div><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/assets/js/app.0cb9f04a.js" defer></script><script src="/assets/js/3.bef602aa.js" defer></script><script src="/assets/js/1.0846dacc.js" defer></script><script src="/assets/js/81.9c0e369b.js" defer></script>
  </body>
</html>
